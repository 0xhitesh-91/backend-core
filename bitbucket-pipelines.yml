image: node:16.15.1
pipelines:
    default:
      - step:
          name: test
          caches:
            - node
          script:
            - apt-get update
            - apt-get install postgresql-client -y
            - cd functions
            - npm install
            - npm run db:create --env=ci
            - npm run db:migrate --env=ci
            - npm run test:ci
          services:
            - db
definitions:
  services:
    db:
      image: postgres:latest
      variables:
        POSTGRES_USER: 'root'
        POSTGRES_PASSWORD: 'root'