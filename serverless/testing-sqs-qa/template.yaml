# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

# The AWSTemplateFormatVersion identifies the capabilities of the template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/format-version-structure.html
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  testing-sqs-qa

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform:
  - AWS::Serverless-2016-10-31

Parameters:
  AllSubnets:
    Type: List<AWS::EC2::Subnet::Id>
  SecurityGroupId:
    Type: List<AWS::EC2::SecurityGroup::Id>
  Environment:
    Type: String
  ProjectName:
    Type: String
  SMSQueueArn:
    Type: String

Conditions:
  AddVpcConfig: !Not [ !Equals [ !Ref Environment, "qaLocal" ] ]

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:
  # CommonLayer:
  #   Type: AWS::Serverless::LayerVersion
  #   Properties:
  #     LayerName: CommonLayer
  #     Description: Dependencies for the blank sample app.
  #     ContentUri: ../layers/nodejs/
  #     CompatibleRuntimes:
  #       - nodejs18.x
  #   Metadata:
  #     BuildMethod: nodejs18.x
  # This is an SQS queue with all default configuration properties. To learn more about the available options, see
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-sqs-queues.html
  SendSMS:
    Type: AWS::Serverless::Function
    Properties:
      Description: A Lambda function that logs the payload of messages sent to an associated SQS queue.
      Runtime: nodejs16.x
      Architectures:
        - x86_64
      Handler: src/handlers/sqs-payload-logger.sqsPayloadLoggerHandler
      # Layers:
      #   - !Ref CommonLayer
      Events:
        SQSQueueEvent:
          Type: SQS
          Properties:
            Queue: !Ref SMSQueueArn
      MemorySize: 128
      Timeout: 25 # Chosen to be less than the default SQS Visibility Timeout of 30 seconds
      Policies:
        - AWSLambdaBasicExecutionRole
      VpcConfig:
        SecurityGroupIds:
          - !If [AddVpcConfig, !Ref SecurityGroupId, !Ref "AWS::NoValue"]
        SubnetIds: 
          - !If [AddVpcConfig, !Ref AllSubnets, !Ref "AWS::NoValue"]
  
      Tags:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
  